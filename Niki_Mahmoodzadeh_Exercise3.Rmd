---
title: "Exercise 3"
author: "Niki Mahmoodzadeh"
date: "2024-03-31"
output:
  html_document: default
  word_document: default
---

# Introduction

This analysis delves into the demographic composition of patent examiners and the dynamics of their advice networks within the United States Patent and Trademark Office (USPTO).

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
install.packages("gender")
install.packages("wru")
library(tidyverse)
library(lubridate)
library(gender)
library(wru)
library(igraph)
library(ggraph)
library(gridExtra)


```

# Data loading and preprocessing

As a first step, the necessary data is loaded and prepared for the subsequent analysis:


```{r data}
applications <- read_csv("/Users/nikimahmoodzadeh/Downloads/672_project_data-2/app_data_sample.csv")
edges <- read_csv("/Users/nikimahmoodzadeh/Downloads/672_project_data-2/edges_sample.csv")

```

# Demographic analysis

## Gender estimation

To gain insights into gender diversity, the gender of examiners is estimated based on their first names.

```{r gender-estimation, echo=FALSE}
examiner_names = applications %>%
  distinct(examiner_name_first) %>%
  drop_na(examiner_name_first)

examiner_names_gender = examiner_names %>%
  rowwise() %>%
  mutate(gender = gender(examiner_name_first, method = "ssa")$gender[1]) %>%
  ungroup() %>%
  select(examiner_name_first, gender)

applications = applications %>%
  left_join(examiner_names_gender, by = "examiner_name_first")


```

## Race estimation

To explore the racial composition, the racial background of the examiners is estimated using their last names.

```{r race-estimation, echo=FALSE}
examiner_surnames = applications %>%
  distinct(examiner_name_last) %>%
  drop_na(examiner_name_last) %>%
  rename(surname = examiner_name_last)

examiner_race = examiner_surnames %>%
  mutate(race = predict_race(voter.file = examiner_surnames, surname.only = TRUE)) %>%
  select(surname, race)

applications = applications %>%
  left_join(examiner_race, by = c("examiner_name_last" = "surname"))

```

## Tenure calculation

To understand the level of experience and potential turnover within the organization, the tenure of examiners is calculated.


```{r tenure-calculation, echo=FALSE}
applications = applications %>%
  mutate(filing_date = ymd(filing_date),
         appl_status_date = ymd_hms(appl_status_date),
         tenure_days = as.numeric(appl_status_date - filing_date))


```


# Workgroup analysis

For a more granular analysis, two specific workgroups are selected to compare their demographic characteristics.


```{r workgroup-analysis, echo=FALSE}
workgroup_ids = substr(applications$examiner_art_unit, 1, 3) %>%
  unique() %>%
  sort(decreasing = TRUE) %>%
  head(2)

applications_filtered = applications %>%
  filter(substr(examiner_art_unit, 1, 3) %in% workgroup_ids)

```

# Network analysis

## Advice network creation

To understand the patterns of interaction and knowledge sharing among examiners, the advice networks are constructed and examined.

```{r network-creation, echo=FALSE}
# extract unique examiner IDs from the edges data frame
unique_examiner_ids = unique(c(edges$ego_examiner_id, edges$alter_examiner_id))

# create the vertices data frame with unique examiner IDs
vertices_df = data.frame(name = unique_examiner_ids)

# create the edges data frame with the correct mapping
edges_df = edges %>%
  filter(ego_examiner_id %in% unique_examiner_ids & alter_examiner_id %in% unique_examiner_ids) %>%
  select(ego = ego_examiner_id, alter = alter_examiner_id)

# create the advice network graph with explicit vertices and edges
advice_network = graph_from_data_frame(d = edges_df, vertices = vertices_df, directed = TRUE)

# check the order of the graph (number of vertices)
gorder(advice_network)

```


## Centrality scores

To identify influential individuals and key collaborators within the network, centrality scores are calculated for each examiner.

```{r centrality-scores, echo=FALSE}
# calculate centrality scores
centrality_scores = data.frame(
  examiner_id = as.numeric(V(advice_network)$name),  # Convert to numeric to match applications
  degree = degree(advice_network),
  closeness = closeness(advice_network),
  betweenness = betweenness(advice_network)
)

# ensure examiner_id in applications is of type numeric (double)
applications$examiner_id <- as.numeric(applications$examiner_id)

# performing the join
applications = applications %>%
  left_join(centrality_scores, by = "examiner_id")


```


# Results and discussion

The following sections present the findings and insights derived from the analysis of the USPTO examiner data.

## Demographic distribution

```{r demographic-distribution, echo=FALSE}
applications_filtered = applications

# Summarize the data by examiner_art_unit, race, and gender
applications_summary <- applications_filtered %>%
  count(examiner_art_unit, race, gender)

# Create the plot using the summarized data
ggplot(applications_summary, aes(x = race, y = n, fill = gender)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_wrap(~examiner_art_unit) +
  labs(x = "Race", y = "Count", fill = "Gender") +
  theme_minimal()

```



## Network visualization

To visualize the interactions and connections within the advice network, a graph is created with nodes representing examiners and edges representing the flow of advice.

```{r network-visualization, echo=FALSE}

V(advice_network)$degree = degree(advice_network)

# Add gender information to the graph's vertices
# 'examiner_id' in 'applications' corresponds to vertex names in 'advice_network'
gender_info = applications %>% 
  select(examiner_id, gender) %>% 
  distinct()

gender_info$examiner_id <- as.character(gender_info$examiner_id)

# Merge gender info into the graph
for (i in seq_along(V(advice_network))) {
  vertex_name <- V(advice_network)$name[i]
  V(advice_network)$gender[i] <- gender_info$gender[gender_info$examiner_id == vertex_name]
}

# plot the network
ggraph(advice_network, layout = "kk") +
  geom_edge_link(color = "gray80") +
  geom_node_point(aes(size = degree, color = gender)) +
  theme_minimal() +
  labs(title = "Advice Network by Centrality and Gender")

```

## Demographic statistics

```{r demographic-statistics, echo=FALSE}
# Distribution by gender and race
# Distribution by gender and race
gender_distribution = applications %>% 
  group_by(gender) %>% 
  summarise(Count = n())

race_distribution = applications %>% 
  group_by(race) %>% 
  summarise(Count = n())

# Print the distributions
print(gender_distribution)
print(race_distribution)
```


## Network centrality measures

```{r network-centrality-measures, echo=FALSE}
# Centrality summary statistics
centrality_summary=centrality_scores %>% 
  summarise(
    Average_Degree = mean(degree, na.rm = TRUE),
    Median_Degree = median(degree, na.rm = TRUE),
    Average_Closeness = mean(closeness, na.rm = TRUE),
    Median_Closeness = median(closeness, na.rm = TRUE),
    Average_Betweenness = mean(betweenness, na.rm = TRUE),
    Median_Betweenness = median(betweenness, na.rm = TRUE)
  )

print(centrality_summary)


```


# Conclusion

The analysis of the USPTO data reveals a diverse mix of examiners from various racial backgrounds, with a notable presence of White and Asian individuals. However, there is potential for increased representation across all groups, particularly among Hispanic and Black communities. The gender distribution also exhibits a skew towards men, with a significant portion of missing gender information. Further investigation into the reasons behind this disparity and efforts to achieve a more balanced representation would be beneficial.

Examining the advice network within the organization provides valuable insights into the flow of knowledge and support among colleagues. While many examiners have a tight-knit group of contacts, a select few emerge as central figures, acting as crucial nodes in the network. These individuals play a vital role in facilitating information exchange. However, it is important to note that overall connectivity could be enhanced, as the majority of examiners do not consistently bridge communication gaps, with only a limited number serving as frequent connectors.

These findings underscore the opportunity to cultivate stronger connections throughout the organization, fostering a more vibrant and collaborative environment. By promoting greater diversity and encouraging more extensive interaction and knowledge sharing, the USPTO can create a dynamic and inclusive atmosphere that harnesses the collective creativity and expertise of its examiners.
